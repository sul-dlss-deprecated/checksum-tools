#!/usr/bin/env ruby

require 'rubygems'
require 'bundler/setup'
require 'checksum_tools'
require 'optparse'
require 'progressbar'

digests = []
filemasks = []
options = {
  :exclude => [],
  :extension => '.digest',
  :overwrite => false,
  :recursive => false,
}

optparse = OptionParser.new do |opts|
  opts.banner = "Usage: #{$0} [options]"
  
  opts.on('-e', '--extension EXT', "File extension for digest files") do |ext|
    options[:extension] = ext
  end
  
  opts.on('-f', '--filemask MASK', "Include files matching MASK") do |mask|
    filemasks << mask
  end

  opts.on('-r', '--recursive', "Recurse into subdirectories") do
    options[:recursive] = true
  end
  
  opts.on('-x', '--exclude MASK', "Exclude files matching MASK") do |mask|
    options[:exclude] << mask
  end
  
  opts.on('-h', '--help', "Show help") do
    puts opts
    exit
  end
end

optparse.parse!
filemasks << '*' if filemasks.length == 0
digests << :md5 if digests.length == 0

args = digests + [options]
tool = Checksum::Tools.new(*args)
pbar = nil
tool.verify_digest_files(".",filemasks) do |filename, size, pos, result|
  if result.nil?
    if pos > -1
      pbar ||= ProgressBar.new(File.basename(filename), size)
      pbar.set(pos)
    end
  else
    pbar.finish
    pbar = nil
    pass = true
    result.values.each { |val| pass &&= val }
    puts "#{pass ? 'PASS' : 'FAIL'} #{filename}"
  end
end
